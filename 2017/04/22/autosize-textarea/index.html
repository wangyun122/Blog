<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> vue实现自增长的文本域 · this.dog</title><meta name="description" content="vue实现自增长的文本域 - wangyun"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://this.dog/atom.xml" title="this.dog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/wangyun122" target="_blank" class="nav-list-link">WEIBO</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">vue实现自增长的文本域</h1><div class="post-info">Apr 22, 2017</div><div class="post-content"><p>  最近一直在看Element和iview的源码。iview有很多代码都借鉴了element，比如在input，select等模块，之前Element一周年的时候还发文把iveiw给喷了一顿。<br>做下笔记，如何实现一个自增长的文本域。<br>  <script src="https://unpkg.com/vue/dist/vue.js"></script><br>  <style><br>    .wrapper {<br>      display: inline-block;<br>      width: 100%;<br>      position: relative;<br>      vertical-align: middle;<br>      margin: 0;<br>      padding: 0;<br>    }</p>
<pre><code>textarea {
  max-width: 100%;
  vertical-align: bottom;
  font-size: 14px;
}

.i-input {
  display: inline-block;
  width: 300px;
  line-height: 1.5;
  padding: 4px 7px;
  border: 1px solid #d7dde4;
  border-radius: 4px;
  color: #657180;
  background-color: #fff;
  background-image: none;
  position: relative;
  cursor: text;
}

.i-input:hover {
  border-color: #42b983;
}

.i-input:focus {
  border-color: #42b983;
  outline: 0;
}
</code></pre><p>  </style></p>
  <div id="app"><br>    <div class="wrapper"><br>      <textarea class="i-input" ref="textarea" :style="textareaStyles" placeholder="请输入..." :value="currentValue" @input="handleInput"><br>        </textarea><br>    </div><br>  </div>

<script>
var hiddenTextarea;

    var HIDDEN_STYLE = `
    height:0 !important;
    min-height:0 !important;
    max-height:none !important;
    visibility:hidden !important;
    overflow:hidden !important;
    position:absolute !important;
    z-index:-1000 !important;
    top:0 !important;
    right:0 !important
`;

  var CONTEXT_STYLE = [
      'letter-spacing',
      'line-height',
      'padding-top',
      'padding-bottom',
      'font-family',
      'font-weight',
      'font-size',
      'text-rendering',
      'text-transform',
      'width',
      'text-indent',
      'padding-left',
      'padding-right',
      'border-width',
      'box-sizing'
    ];
    new Vue({
      el: '#app',
      data: {
        textareaStyles: {},
        currentValue: this.value,
        autosize: {
          type: [Object, Boolean],
          defaule: true
        }
      },
      mounted:function(){
        this.resizeTextarea();
      },
      watch:{
        value:function(val){
          this.setCurrentValue(val);
        }
      }
      methods: {
        handleInput: function(event) {
          var value = event.target.value;
          if (this.number) value = Number.isNaN(Number(value)) ? value : Number(value);
          this.setCurrentValue(value);
        },
        setCurrentValue: function(value) {
          if (value === this.currentValue) return;
          this.$nextTick(() => {
            this.resizeTextarea();
          });
          this.currentValue = value;
        },
        resizeTextarea() {
          const autosize = this.autosize;

          const minRows = autosize.minRows;
          const maxRows = autosize.maxRows;

          this.textareaStyles = this.calcTextareaHeight(this.$refs.textarea, minRows, maxRows);
        },
        calcTextareaHeight(targetNode, minRows = null, maxRows = null) {
          if (!hiddenTextarea) {
            hiddenTextarea = document.createElement('textarea');
            document.body.appendChild(hiddenTextarea);
          }

          let {
            paddingSize,
            borderSize,
            boxSizing,
            contextStyle
          } = this.calculateNodeStyling(targetNode);

          hiddenTextarea.setAttribute('style', `${contextStyle};${HIDDEN_STYLE}`);
          hiddenTextarea.value = targetNode.value || targetNode.placeholder || '';

          let height = hiddenTextarea.scrollHeight;
          let minHeight = -Infinity;
          let maxHeight = Infinity;

          if (boxSizing === 'border-box') {
            height = height + borderSize;
          } else if (boxSizing === 'content-box') {
            height = height - paddingSize;
          }

          hiddenTextarea.value = '';
          let singleRowHeight = hiddenTextarea.scrollHeight - paddingSize;

          if (minRows !== null) {
            minHeight = singleRowHeight * minRows;
            if (boxSizing === 'border-box') {
              minHeight = minHeight + paddingSize + borderSize;
            }
            height = Math.max(minHeight, height);
          }
          if (maxRows !== null) {
            maxHeight = singleRowHeight * maxRows;
            if (boxSizing === 'border-box') {
              maxHeight = maxHeight + paddingSize + borderSize;
            }
            height = Math.min(maxHeight, height);
          }

          return {
            height: `${height}px`,
            minHeight: `${minHeight}px`,
            maxHeight: `${maxHeight}px`
          };
        },
        calculateNodeStyling: function(node) {
          const style = window.getComputedStyle(node);

          const boxSizing = style.getPropertyValue('box-sizing');

          const paddingSize = (
            parseFloat(style.getPropertyValue('padding-bottom')) +
            parseFloat(style.getPropertyValue('padding-top'))
          );

          const borderSize = (
            parseFloat(style.getPropertyValue('border-bottom-width')) +
            parseFloat(style.getPropertyValue('border-top-width'))
          );

          const contextStyle = CONTEXT_STYLE
            .map(name => `${name}:${style.getPropertyValue(name)}`)
            .join(';');

          return {
            contextStyle,
            paddingSize,
            borderSize,
            boxSizing
          };
        }

      }
    })
  </script>

<p>实现的核心就是如何计算文本域的高度。原理就是<code>calcTextareaHeight</code>方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> hiddenTextarea;</div><div class="line"></div><div class="line"><span class="keyword">const</span> HIDDEN_STYLE = <span class="string">`</span></div><div class="line">    height:0 !important;</div><div class="line">    min-height:0 !important;</div><div class="line">    max-height:none !important; </div><div class="line">    visibility:hidden !important;</div><div class="line">    overflow:hidden !important;</div><div class="line">    position:absolute !important;</div><div class="line">    z-index:-1000 !important;</div><div class="line">    top:0 !important;</div><div class="line">    right:0 !important</div><div class="line">`;</div><div class="line"></div><div class="line"><span class="keyword">const</span> CONTEXT_STYLE = [</div><div class="line">    <span class="string">'letter-spacing'</span>,</div><div class="line">    <span class="string">'line-height'</span>,</div><div class="line">    <span class="string">'padding-top'</span>,</div><div class="line">    <span class="string">'padding-bottom'</span>,</div><div class="line">    <span class="string">'font-family'</span>,</div><div class="line">    <span class="string">'font-weight'</span>,</div><div class="line">    <span class="string">'font-size'</span>,</div><div class="line">    <span class="string">'text-rendering'</span>,</div><div class="line">    <span class="string">'text-transform'</span>,</div><div class="line">    <span class="string">'width'</span>,</div><div class="line">    <span class="string">'text-indent'</span>,</div><div class="line">    <span class="string">'padding-left'</span>,</div><div class="line">    <span class="string">'padding-right'</span>,</div><div class="line">    <span class="string">'border-width'</span>,</div><div class="line">    <span class="string">'box-sizing'</span></div><div class="line">];</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">calculateNodeStyling</span>(<span class="params">node</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> style = <span class="built_in">window</span>.getComputedStyle(node);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> boxSizing = style.getPropertyValue(<span class="string">'box-sizing'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> paddingSize = (</div><div class="line">        <span class="built_in">parseFloat</span>(style.getPropertyValue(<span class="string">'padding-bottom'</span>)) +</div><div class="line">        <span class="built_in">parseFloat</span>(style.getPropertyValue(<span class="string">'padding-top'</span>))</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">const</span> borderSize = (</div><div class="line">        <span class="built_in">parseFloat</span>(style.getPropertyValue(<span class="string">'border-bottom-width'</span>)) +</div><div class="line">        <span class="built_in">parseFloat</span>(style.getPropertyValue(<span class="string">'border-top-width'</span>))</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">const</span> contextStyle = CONTEXT_STYLE</div><div class="line">        .map(<span class="function"><span class="params">name</span> =&gt;</span> <span class="string">`<span class="subst">$&#123;name&#125;</span>:<span class="subst">$&#123;style.getPropertyValue(name)&#125;</span>`</span>)</div><div class="line">        .join(<span class="string">';'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123;contextStyle, paddingSize, borderSize, boxSizing&#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">calcTextareaHeight</span>(<span class="params">targetNode, minRows = null, maxRows = null</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!hiddenTextarea) &#123;</div><div class="line">        hiddenTextarea = <span class="built_in">document</span>.createElement(<span class="string">'textarea'</span>);</div><div class="line">        <span class="built_in">document</span>.body.appendChild(hiddenTextarea);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">let</span> &#123;</div><div class="line">        paddingSize,</div><div class="line">        borderSize,</div><div class="line">        boxSizing,</div><div class="line">        contextStyle</div><div class="line">    &#125; = calculateNodeStyling(targetNode);</div><div class="line"></div><div class="line">    hiddenTextarea.setAttribute(<span class="string">'style'</span>, <span class="string">`<span class="subst">$&#123;contextStyle&#125;</span>;<span class="subst">$&#123;HIDDEN_STYLE&#125;</span>`</span>);</div><div class="line">    hiddenTextarea.value = targetNode.value || targetNode.placeholder || <span class="string">''</span>;</div><div class="line"></div><div class="line">    <span class="keyword">let</span> height = hiddenTextarea.scrollHeight;</div><div class="line">    <span class="keyword">let</span> minHeight = -<span class="literal">Infinity</span>;</div><div class="line">    <span class="keyword">let</span> maxHeight = <span class="literal">Infinity</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (boxSizing === <span class="string">'border-box'</span>) &#123;</div><div class="line">        height = height + borderSize;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (boxSizing === <span class="string">'content-box'</span>) &#123;</div><div class="line">        height = height - paddingSize;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    hiddenTextarea.value = <span class="string">''</span>;</div><div class="line">    <span class="keyword">let</span> singleRowHeight = hiddenTextarea.scrollHeight - paddingSize;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (minRows !== <span class="literal">null</span>) &#123;</div><div class="line">        minHeight = singleRowHeight * minRows;</div><div class="line">        <span class="keyword">if</span> (boxSizing === <span class="string">'border-box'</span>) &#123;</div><div class="line">            minHeight = minHeight + paddingSize + borderSize;</div><div class="line">        &#125;</div><div class="line">        height = <span class="built_in">Math</span>.max(minHeight, height);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (maxRows !== <span class="literal">null</span>) &#123;</div><div class="line">        maxHeight = singleRowHeight * maxRows;</div><div class="line">        <span class="keyword">if</span> (boxSizing === <span class="string">'border-box'</span>) &#123;</div><div class="line">            maxHeight = maxHeight + paddingSize + borderSize;</div><div class="line">        &#125;</div><div class="line">        height = <span class="built_in">Math</span>.min(maxHeight, height);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">height</span>: <span class="string">`<span class="subst">$&#123;height&#125;</span>px`</span>,</div><div class="line">        <span class="attr">minHeight</span>: <span class="string">`<span class="subst">$&#123;minHeight&#125;</span>px`</span>,</div><div class="line">        <span class="attr">maxHeight</span>: <span class="string">`<span class="subst">$&#123;maxHeight&#125;</span>px`</span></div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在页面上创建一个隐藏的高度为0的textarea，将样式和value都赋值给这个隐藏的textarea，然后通过计算scrollHeight就能拿到textarea需要的高度了。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/04/17/lodash/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://this.dog">wangyun</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>